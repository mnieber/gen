version: "3.7"

services:
  {{ service.name }}:                                                         {% for service in _.project.services %}
    build:                                                                      {% if service.dockerfile %}
      context: ./{{ service.name }}
      dockerfile: Dockerfile.dev                                                {% endif %}
    command: sleep infinity                                                     {% ?? service.serve_command_dev %}
    depends_on:
      - {{ other_service.name }}                                                {% for other_service in service.depends_on %}{% endfor %}
    env_file:
      - {{ env_file }}                                                          {% for env_file in service.env_files_dev %}{% endfor %}
    environment:
      - DJANGO_SETTINGS_MODULE=app.settings.dev                                 {% ?? service.django_app %}
      - CHOKIDAR_USEPOLLING=true                                                {% ?? service.react_app %}
    image: {{ __.get_image(service) }}
    ports:
      - {{ port }}                                                              {% for port in service.ports.values() %}{% endfor %}
    volumes:
      - ./{{ service.name }}:{{ service.install_dir }}/src                      {% ?? service.dockerfile %}
      - postgres_data:/var/lib/postgresql/data                                  {% ?? service.name == "postgres" %}
      - {{ service.name }}_venv:{{ service.install_dir }}/env                   {% ?? service.pip %}
                                                                              {% endfor %}
volumes:
  postgres_data: {}                                                           {% ?? _.project.get_service_by_name("postgres") %}
  {{ service.name }}_venv: {}                                                 {% for service in _.project.services %}{% ?? service.pip %}{% endfor %}