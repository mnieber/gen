{% magic_with _.component.name as YellowTulipFormView %}
{% magic_with __.mutation.name as postRedRose %}
{% magic_with field_spec.ts_type as fieldSpecTsType %}
{% magic_with field_spec.ts_default_value as fieldSpecTsDefaultValue %}
{% magic_with field_spec.name as fieldSpecName %}
{% magic_with field_spec.target as FieldSpecTarget %}
import React from 'react';
import * as R from 'ramda';
import { observer } from 'mobx-react-lite';
import { withDefaultProps } from 'react-default-props-context';
import {
  FormStateProvider,
  HandleValidateArgsT,
  HandleSubmitArgsT
} from 'react-form-state-context';
import { usePostRedRose } from 'src/api/mutations';
import {
  ControlledCheckbox,
  Field,
  GlobalError,
  TextField,
  SaveButton,
  SlugField,
  UpdateSlugButton,
  ValuePickerField
} from 'src/forms/components';
import { createUUID } from 'src/utils/ids';
import { cn } from 'src/utils/classnames';
import { fieldSpecTsType } from 'src/api/types/fieldSpecTsType'                             {% !! field_spec in __.fk_field_specs %}

import './YellowTulipFormView.scss';

type PropsT = {};

const DefaultProps = {
  ...dps.fieldSpecTargets,                                                                  {% !! field_spec in __.fk_field_specs %}
};

export const YellowTulipFormView = observer(
  withDefaultProps((props: PropsT & typeof DefaultProps) => {
    const postRedRose = usePostRedRose().mutateAsync;

    const initialValues = {
      id: createUUID(),
      fieldSpecName: fieldSpecTsDefaultValue,                                               {% for field_spec in __.field_specs %}{% ?? not field_spec.target %}{% endfor %}
    };
    const initialErrors = {};
    const handleValidate = ({values, setError} : HandleValidateArgsT) => {
      if (R.isNil(values.fieldSpecName)) {                                                  {% for field_spec in __.field_specs %}{% if "client" not in field_spec.optional %}
        setError('fieldSpecName', 'This field is required');
      }                                                                                     {% endif %}{% endfor %}
    };
    const handleSubmit = ({ formState, values }: HandleSubmitArgsT) => {
      postRedRose({
        ...values,
        fieldSpecName: values.fieldSpecName.id,                                             {% for field_spec in __.field_specs %}{% ?? field_spec.field_type in ("uuid",) and field_spec.target %}{% endfor %}
      });
      formState.reset(initialValues, initialErrors);
    };

    return (
      <div
        className={cn(
          "YellowTulipFormView",
          "flex flex-col items-center",
          "w-full"
        )}>
        <FormStateProvider
          initialValues={initialValues}
          initialErrors={initialErrors}
          handleValidate={handleValidate}
          handleSubmit={handleSubmit}
        >
          <GlobalError />
          <Field                                                                                      {% for field_spec in __.field_specs %}
            fieldName="fieldSpecName"
            label="FieldSpecName"
            buttons={[                                                                                {% if field_spec.field_type in ("slug",) %}
              <UpdateSlugButton
                key="1"
                relatedFieldName="{{ field_spec.slug_src }}"
              />
            ]}                                                                                        {% endif %}
          >
            <TextField controlled={true} />                                                           {% ?? field_spec.field_type in ("string", "text", "url") %}
            <SlugField />                                                                             {% ?? field_spec.field_type in ("slug",) %}
            <ValuePickerField                                                                         {% if field_spec.field_type in ("uuid",) and field_spec.target %}
              isCreatable={false}
              isMulti={false}
              pickableValues={props.fieldSpecTargets}
              labelFromValue={(x: any) => x.{{ field_spec.target_type_spec.display_item_by }} }
            />                                                                                        {% endif %}
            <ControlledCheckbox />                                                                    {% ?? field_spec.field_type in ("boolean",) %}
          </Field>                                                                                    {% endfor %}
          <SaveButton
            label="Save"
            disabled={false}
          />
        </FormStateProvider>
      </div>
    );
  }, DefaultProps)
);
{% end_magic_with %}
{% end_magic_with %}
{% end_magic_with %}
{% end_magic_with %}
{% end_magic_with %}
{% end_magic_with %}
